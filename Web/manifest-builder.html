<!doctype html>
<meta charset="utf-8" />
<title>RubiKit Manifest Builder</title>
<style>
  body { font-family: system-ui, sans-serif; background:#111; color:#eee; padding:16px }
  button { background:#333; color:#eee; border:1px solid #444; border-radius:6px; padding:8px 12px; cursor:pointer; }
  button:hover{ background:#444; }
  pre, textarea { width:100%; min-height:220px; background:#0d0d0d; color:#0f0; border:1px solid #333; border-radius:8px; padding:8px; }
  .muted{ color:#aaa }
</style>
<h1>RubiKit Manifest Builder</h1>
<p>1) Click <b>Pick modules folder</b> and select your <code>RubiKit/modules</code> directory.<br>
2) Review the generated manifest below.<br>
3) Click <b>Save modules.json</b> to write it into that folder.</p>

<p class="muted">Works best on Chrome/Edge at <code>http://127.0.0.1</code>. Uses the File System Access API.</p>

<div style="display:flex; gap:8px; margin:12px 0">
  <button id="pick">Pick modules folder</button>
  <button id="save" disabled>Save modules.json</button>
</div>

<pre id="log"></pre>
<textarea id="out" spellcheck="false" placeholder="{ manifest will appear here }"></textarea>

<script>
const log = msg => { const el = document.getElementById('log'); el.textContent += msg + "\n"; el.scrollTop = el.scrollHeight; };

async function readJsonLenient(file) {
  const txt = await file.text();
  try { return JSON.parse(txt); }
  catch {
    const clean = txt.replace(/^\uFEFF/,'').replace(/\/\/[^\n\r]*|\/\*[\s\S]*?\*\//g,'').replace(/,\s*([}\]])/g,'$1');
    return JSON.parse(clean);
  }
}

let pickedDir = null;
let manifest = { modules: [] };

document.getElementById('pick').onclick = async () => {
  if (!('showDirectoryPicker' in window)) {
    log('‚ùå Your browser does not support folder access. Use Chrome/Edge.');
    return;
  }
  try {
    pickedDir = await window.showDirectoryPicker({ id: 'rubikit-modules', mode: 'readwrite' });
    log('üìÇ Picked: ' + pickedDir.name);
    // Crawl subdirectories
    const subs = [];
    for await (const [name, handle] of pickedDir.entries()){
      if (handle.kind === 'directory') subs.push({ name, handle });
    }
    if (!subs.length){ log('‚ö†Ô∏è No subfolders in that directory.'); return; }

    const found = [];
    for (const {name, handle} of subs){
      // Prefer module.json
      let meta = null;
      try {
        const fh = await handle.getFileHandle('module.json');
        const f = await fh.getFile();
        meta = await readJsonLenient(f);
      } catch {}

      if (meta){
        const rel = meta.href || meta.entry || meta.index || meta.url || "index.html";
        found.push({
          id: meta.id || name,
          name: meta.name || name,
          icon: meta.icon || "üß©",
          description: meta.description || "",
          tags: meta.tags || [],
          href: `${name}/${rel}`
        });
        log(`‚úì ${name} (module.json)`);
        continue;
      }

      // Fallback: index.html
      try {
        await handle.getFileHandle('index.html');
        found.push({
          id: name,
          name: name.replace(/[-_]/g,' ').replace(/\b\w/g,c=>c.toUpperCase()),
          icon: "üß≠",
          description: "",
          tags: [],
          href: `${name}/index.html`
        });
        log(`‚úì ${name} (index.html)`);
      } catch {
        log(`‚Äì ${name} (no module.json or index.html)`);
      }
    }

    manifest = { modules: found };
    document.getElementById('out').value = JSON.stringify(manifest, null, 2);
    document.getElementById('save').disabled = found.length === 0;
    log(`‚úî Found ${found.length} module(s).`);

  } catch (e) {
    log('‚ùå Picker canceled or failed: ' + (e.message || e));
  }
};

document.getElementById('save').onclick = async () => {
  if (!pickedDir || !manifest.modules.length){ log('‚ö†Ô∏è Nothing to save.'); return; }
  try {
    const fh = await pickedDir.getFileHandle('modules.json', { create: true });
    const w = await fh.createWritable();
    await w.write(JSON.stringify(manifest, null, 2));
    await w.close();
    log('üíæ Wrote modules.json to the selected folder.');
  } catch (e) {
    log('‚ùå Save failed: ' + (e.message || e));
  }
};
</script>
