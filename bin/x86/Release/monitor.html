<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NotumHUD · Monitor (Read-only)</title>
<style>
:root{
  --bg:#0e1116; --panel:#151a21; --inset:#0a0e12; --border:#243041;
  --text:#d6dde7; --muted:#8ea0b5; --accent:#8A63D2; --glow:rgba(138,99,210,0.35);
  --green:#3fb950; --red:#f85149; --yellow:#e3b341; --blue:#58a6ff;
  --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;
  --ui: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f14 0%, #0e1116 100%);color:var(--text);font-family:var(--ui)}
.container{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#161c24,#12171e)}
.header h1{margin:0;font-size:16px;color:var(--accent);text-shadow:0 0 10px var(--glow)}
.status{display:flex;align-items:center;gap:8px;color:var(--muted);font-weight:600}
.dot{width:10px;height:10px;border-radius:50%;background:var(--yellow)}
.dot.live{background:var(--green)} .dot.error{background:var(--red)}
.grid{display:grid;grid-template-columns:1.15fr 1.35fr;gap:12px;padding:12px;height:calc(100vh - 53px);min-height:0}
.column{display:flex;flex-direction:column;gap:12px;min-height:0}
.right-col{display:grid;grid-auto-rows:max-content;gap:12px;min-height:0}
.panel{display:flex;flex-direction:column;background:var(--panel);border:1px solid var(--border);border-radius:10px;min-height:0}
.panel-title{margin:0;font-size:14px;font-weight:700;padding:10px 12px;border-bottom:1px solid var(--border)}
.panel-content{padding:10px;overflow:auto;min-height:0}
.btn{background:var(--inset);border:1px solid var(--border);color:var(--muted);padding:6px 10px;border-radius:8px;cursor:pointer}
.btn:hover{color:var(--text);border-color:var(--accent)}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.tag{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:var(--inset);color:var(--muted);font-size:12px}
.small{font-size:12px;color:var(--muted)}
.kv{display:flex;gap:6px;margin:2px 0}
.key{color:var(--muted)} .val{color:var(--text);font-weight:700}
#tree{font-family:var(--mono);font-size:12px}
#tree details{margin-left:8px}
#tree summary{cursor:pointer}
.input{background:var(--inset);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;outline:none}
.input::placeholder{color:var(--muted)}
.console{font-family:var(--mono);font-size:12px;background:var(--inset);border-radius:8px;padding:8px;line-height:1.45;white-space:pre-wrap;word-break:break-word;height:260px;overflow:auto;border:1px solid var(--border)}
#server-log{height:220px}
#pkt{height:140px;color:var(--muted)}
.logline{padding:1px 0}
.info{color:var(--blue)} .success{color:var(--green)} .error{color:var(--red)} .warn{color:var(--yellow)}
kbd{background:#11161d;border:1px solid var(--border);border-bottom-color:#1b2736;border-radius:6px;padding:1px 6px;box-shadow:inset 0 -2px 0 rgba(0,0,0,.25)}
.hide{display:none!important}
</style>
</head>
<body>
<div class="container">
  <header class="header">
    <h1>NotumHUD Monitor (Read-only)</h1>
    <div class="status"><div id="dot" class="dot"></div><span id="status">Idle</span></div>
  </header>

  <main class="grid">
    <!-- LEFT -->
    <div class="column">
      <!-- API Explorer -->
      <section class="panel">
        <h2 class="panel-title">API Explorer</h2>
        <div class="panel-content">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="tag">Meta: <strong id="meta-ver">—</strong></span>
              <span class="tag">Config: <span id="meta-cfg">—</span></span>
              <a class="tag" href="/health" target="_blank" rel="noreferrer">/health</a>
            </div>
            <div class="row">
              <input id="search" class="input" style="width:240px" placeholder="Filter stats (e.g., Rifle)" />
              <button id="refresh-meta" class="btn">Refresh Meta</button>
            </div>
          </div>

          <h3 style="margin:10px 0 4px 0">C# Subscribers</h3>
          <ul id="subs" style="margin:0 0 10px 16px;color:var(--muted)">
            <li>Awaiting data...</li>
          </ul>

          <hr style="border:0;border-top:1px solid var(--border);margin:8px 0" />
          <div id="tree">{ "message": "Awaiting first data packet..." }</div>
        </div>
      </section>

      <!-- Packet Inspector -->
      <section class="panel">
        <h2 class="panel-title">Packet Inspector</h2>
        <div class="panel-content">
          <div id="pkt" class="console"></div>
        </div>
      </section>
    </div>

    <!-- RIGHT -->
    <div class="column right-col">
      <!-- Server Log -->
      <section class="panel">
        <h2 class="panel-title">Server Log</h2>
        <div class="panel-content">
          <div class="row" style="margin-bottom:8px">
            <button id="copy-log" class="btn">Copy</button>
            <button id="clear-log" class="btn">Clear</button>
            <span class="small">Logs stream from <code>/logs</code></span>
          </div>
          <div id="server-log" class="console"></div>
        </div>
      </section>

      <!-- Diagnostics (read-only) -->
      <section class="panel">
        <h2 class="panel-title">Diagnostics</h2>
        <div class="panel-content">
          <div class="row" style="gap:8px;margin-bottom:8px">
            <button id="ping-health" class="btn">Ping Health</button>
          </div>
          <pre id="diag" class="console" style="height:240px"></pre>
        </div>
      </section>
    </div>
  </main>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);

  const els = {
    dot: $('dot'), status: $('status'),
    metaVer: $('meta-ver'), metaCfg: $('meta-cfg'),
    search: $('search'), refreshMeta: $('refresh-meta'),
    subs: $('subs'), tree: $('tree'),
    pkt: $('pkt'), log: $('server-log'),
    copyLog: $('copy-log'), clearLog: $('clear-log'),
    pingHealth: $('ping-health'), diag: $('diag'),
  };

  let esStats = null, esLogs = null;
  let reconnectStats = 800, reconnectLogs = 800;
  let lastStats = {};

  function setStatus(t, cls){
    els.status.textContent = t || 'Idle';
    els.dot.className = 'dot' + (cls?(' ' + cls):'');
  }

  function addLine(container, text, cls, max){
    const d = document.createElement('div');
    d.className = 'logline' + (cls ? (' ' + cls) : '');
    d.textContent = '[' + new Date().toLocaleTimeString() + '] ' + text;
    container.appendChild(d);
    while (container.children.length > max) container.removeChild(container.firstChild);
    container.scrollTop = container.scrollHeight;
  }

  function pkt(m){ addLine(els.pkt, m, '', 600); }
  function slog(m, level){
    const cls = level || (/error|fail/i.test(m) ? 'error' : /warn|retry/i.test(m) ? 'warn' : /ok|live|connected/i.test(m) ? 'success':'info');
    addLine(els.log, m, cls, 1200);
  }

  async function refreshMeta(){
    try{
      const [m,c] = await Promise.all([fetch('/api/meta'), fetch('/api/config')]);
      if(m.ok){ const j = await m.json(); els.metaVer.textContent = j.version || '—'; }
      if(c.ok){
        const j = await c.json();
        const parts = [];
        if ('port' in j) parts.push('port ' + j.port);
        if ('heartbeat_ms' in j) parts.push('hb ' + j.heartbeat_ms + 'ms');
        els.metaCfg.textContent = parts.join(' · ') || '—';
      }
    }catch(e){ slog('Meta/config fetch failed: '+e.message, 'warn'); }
  }

  function updateTree(stats){
    const open = new Map(); els.tree.querySelectorAll('details').forEach(d => open.set(d.dataset.category, d.open));
    const needle = (els.search.value || '').toLowerCase();
    els.tree.innerHTML = '';

    const cats = Object.keys(stats).sort((a,b)=>a==='Misc'?1:b==='Misc'?-1:a.localeCompare(b));
    const wrap = document.createElement('div');
    wrap.style.display='grid'; wrap.style.gridTemplateColumns='1fr 1fr'; wrap.style.gap='12px';

    const mid = Math.ceil(cats.length/2);
    [cats.slice(0,mid), cats.slice(mid)].forEach(col => {
      const cdiv = document.createElement('div');
      col.forEach(cat => {
        const d = document.createElement('details'); d.dataset.category = cat; d.open = false;
        const s = document.createElement('summary'); s.textContent = cat; d.appendChild(s);
        Object.keys(stats[cat]).forEach(k => {
          if (needle && !k.toLowerCase().includes(needle)) return;
          const kv = document.createElement('div'); kv.className='kv';
          const key = document.createElement('span'); key.className='key'; key.textContent = k + ':';
          const val = document.createElement('span'); val.className='val'; val.textContent = stats[cat][k];
          kv.appendChild(key); kv.appendChild(val); d.appendChild(kv);
        });
        if (open.has(cat)) d.open = open.get(cat);
        if (needle && d.querySelectorAll('.kv').length) d.open = true;
        cdiv.appendChild(d);
      });
      wrap.appendChild(cdiv);
    });

    els.tree.appendChild(wrap);
  }

  // ---- Streams ----
  function connectStats(){
    try { if (esStats) esStats.close(); } catch {}
    slog('Connecting to /events…'); setStatus('Connecting…','');
    try { esStats = new EventSource('/events'); }
    catch(e){ slog('EventSource init failed: '+e.message,'error'); setStatus('Error','error'); return; }
    esStats.onopen = () => { slog('SSE (stats) connected.','success'); setStatus('Live','live'); reconnectStats = 800; };
    esStats.onmessage = ev => {
      pkt('Stats packet ' + new Blob([ev.data]).size + ' bytes');
      try {
        const data = JSON.parse(ev.data);
        const stats = data.stats || data.all || {};
        // If server sends flat "all", wrap into a "Misc" group for display
        if (data.stats) {
          updateTree(data.stats);
          els.subs.innerHTML = (data.csharp_subscribers && data.csharp_subscribers.length)
            ? data.csharp_subscribers.map(s => `<li>${s}</li>`).join('')
            : '<li style="color:var(--muted)">No C# subscribers</li>';
        } else {
          updateTree({ Misc: stats });
          els.subs.innerHTML = '<li style="color:var(--muted)">No C# subscribers</li>';
        }
      } catch (e){ slog('Stats JSON error: '+e.message,'error'); }
    };
    esStats.onerror = () => {
      setStatus('Error','error'); slog('SSE (stats) error. Reconnecting…','warn');
      try { esStats.close(); } catch {}
      esStats = null;
      setTimeout(connectStats, reconnectStats);
      reconnectStats = Math.min(reconnectStats * 2, 8000);
    };
  }

  function connectLogs(){
    try { if (esLogs) esLogs.close(); } catch {}
    slog('Connecting to /logs…');
    try { esLogs = new EventSource('/logs'); }
    catch(e){ slog('Logs EventSource init failed: '+e.message,'error'); return; }
    esLogs.onopen = () => { slog('SSE (logs) connected.','success'); reconnectLogs = 800; };
    esLogs.onmessage = ev => { addLine(els.log, ev.data, '', 1200); };
    esLogs.onerror = () => {
      slog('SSE (logs) error. Reconnecting…','warn');
      try { esLogs.close(); } catch {}
      esLogs = null;
      setTimeout(connectLogs, reconnectLogs);
      reconnectLogs = Math.min(reconnectLogs * 2, 8000);
    };
  }

  // ---- Diagnostics (read-only) ----
  async function pingHealth(){
    try{
      const r = await fetch('/health', {signal: AbortSignal.timeout(1500)});
      const ok = r.ok ? 'OK' : ('HTTP ' + r.status);
      slog('/health ' + ok, r.ok?'success':'error');
      els.diag.textContent = 'GET /health → ' + ok + '\n' + els.diag.textContent;
    }catch{ slog('/health fail','error'); els.diag.textContent = 'GET /health → failed\n' + els.diag.textContent; }
  }

  // ---- Wire up ----
  $('copy-log').addEventListener('click', () => {
    const lines = Array.from(els.log.children).map(n => n.textContent).join('\n');
    navigator.clipboard.writeText(lines).then(()=>slog('Copied server log.','success'));
  });
  $('clear-log').addEventListener('click', () => { els.log.innerHTML = ''; });
  $('ping-health').addEventListener('click', pingHealth);
  $('refresh-meta').addEventListener('click', refreshMeta);
  $('search').addEventListener('input', () => updateTree(lastStats));

  refreshMeta();
  connectStats();
  connectLogs();
  slog('Monitor ready (read-only).','info');
})();
</script>
</body>
</html>
